<!--
  Copyright 2016 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  Authors:
     - Olaf Hahn
-->


<!-- CameraPi TakePhoto -->
<script type="text/x-red" data-template-name="camerapi-takephoto">
    <div class="form-row node-input-filemode">
         <label for="node-input-filemode"><i class="fa fa-file-image-o"></i> <span data-i18n="camerapi.label.filemode"></span></label>
	     <select id="node-input-filemode">
            <option value="2" data-i18n="camerapi.options.automode"></option>
            <option value="1" data-i18n="camerapi.options.custommode"></option>
            <option value="0" data-i18n="camerapi.options.bufferedmode"></option>
        </select>
    </div>
    <div id="filename" class="form-row node-input-filename">
         <label for="node-input-filename"><i class="fa fa-tag"></i> <span data-i18n="camerapi.label.filename"></span></label>
		 <input type="text" id="node-input-filename" data-i18n="[placeholder]camerapi.placeholder.filename">
    </div>
    <div id="filedefpath" class="form-row node-input-filedefpath">
         <label for="node-input-filedefpath"><i class="fa fa-folder"></i> <span data-i18n="camerapi.label.filedefpath"></span></label>
	     <select id="node-input-filedefpath">
            <option value="1" data-i18n="camerapi.options.yes"></option>
            <option value="0" data-i18n="camerapi.options.no"></option>
        </select>
    </div>
    <div id="filepath" class="form-row node-input-filepath">
         <label for="node-input-filepath"><i class="fa fa-folder"></i> <span data-i18n="camerapi.label.filepath"></span></label>
		 <input type="text" id="node-input-filepath" data-i18n="[placeholder]camerapi.placeholder.filepath">
    </div>
    <div id="fileformat" class="form-row node-input-fileformat">
         <label for="node-input-fileformat"><i class="fa fa-file-image-o"></i> <span data-i18n="camerapi.label.fileformat"></span></label>
	     <select id="node-input-fileformat">
            <option value="jpeg">JPEG</option>
            <option value="png">PNG</option>
            <option value="gif">GIF</option>
            <option value="bmp">BMP</option>
            <option value="yuv">YUV</option>
            <option value="rgb">RGB</option>
            <option value="rgba">RGBA</option>
            <option value="bgr">BGR</option>
            <option value="bgra">BGRA</option>
        </select>
    </div>
    <div class="form-row node-input-resolution">
         <label for="node-input-resolution"><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.resolution"></span></label>
	     <select id="node-input-resolution" value="10">
            <option value="1">320x240</option>
            <option value="2">640x480</option>
            <option value="3">800x600</option>
            <option value="4">1024x768</option>
            <option value="5">1280x720</option>
            <option value="6">1640x922</option>
            <option value="7">1640x1232</option>
            <option value="8">1920x1080</option>
            <option value="9">2592x1944</option>
            <option value="10">3280x2464 (v2 camera)</option>
		</select>
    </div>
    <div class="form-row node-input-rotation">
         <label for="node-input-rotation"><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.rotation"></span></label>
	     <select style="width: 100px" id="node-input-rotation">
            <option value="0">0</option>
            <option value="90">90</option>
            <option value="180">180</option>
            <option value="270">270</option>
		</select>
    </div>
    <div id="flip" class="form-row flip-row">
        <label><i class="fa fa-repeat"></i> <span data-i18n="camerapi.label.flip"></span></label>
        <label for="node-input-fliph" style="width: 80px;"><span data-i18n="camerapi.label.hflip"></span></label>
        <select style="width: 60px" id="node-input-fliph">
            <option value="0" data-i18n="camerapi.options.no"></option>
            <option value="1" data-i18n="camerapi.options.yes"></option>
        </select>&nbsp;
        <label for="node-input-flipv" style="width: 80px;"><span data-i18n="camerapi.label.vflip"></span></label>
        <select style="width: 60px" id="node-input-flipv">
            <option value="0" data-i18n="camerapi.options.no"></option>
            <option value="1" data-i18n="camerapi.options.yes"></option>
        </select>
    </div>
    <div class="form-row">
        <label><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.imageproperties"></span></label>
        
        <label for="node-input-brightness" style="width: 80px;"><span data-i18n="camerapi.label.brightness"></span></label>
        <input type="text" style="width: 60px" id="node-input-brightness" data-i18n="[placeholder]camerapi.placeholder.brightness">

        &nbsp;<label for="node-input-contrast" style="width: 80px;"><span data-i18n="camerapi.label.contrast"></span></label>
		<input type="text" style="width: 60px" id="node-input-contrast" data-i18n="[placeholder]camerapi.placeholder.contrast">
    </div>
    <div class="form-row">
        <label></label>

        <label for="node-input-sharpness" style="width: 80px;"><span data-i18n="camerapi.label.sharpness"></span></label>
        <input type="text" style="width: 60px" id="node-input-sharpness" data-i18n="[placeholder]camerapi.placeholder.sharpness">

        &nbsp;<label for="node-input-quality" style="width: 80px;"><span data-i18n="camerapi.label.quality"></span></label>
        <input type="text" style="width: 60px" id="node-input-quality" data-i18n="[placeholder]camerapi.placeholder.quality">
    </div>
   <div class="form-row node-input-imageeffect">
        <label for="node-input-imageeffect"><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.imageeffect"></span></label>
        <select id="node-input-imageeffect">
            <option value="none">none</option>
            <option value="negative">negative</option>
            <option value="sketch">sketch</option>
            <option value="denoise">denoise</option>
            <option value="emboss">emboss</option>
            <option value="oilpaint">oilpaint</option>
            <option value="hatch">hatch</option>
            <option value="gpen">gpen</option>
            <option value="pastel">pastel</option>
            <option value="watercolor">watercolor</option>
            <option value="film">film</option>
            <option value="blur">blur</option>
            <option value="saturation">saturation</option>
            <option value="washedout">washedout</option>
            <option value="cartoon">cartoon</option>
            <option value="deinterlace1">deinterlace1</option>
            <option value="deinterlace2">deinterlace2</option>
        </select>
    </div>
    <div class="form-row node-input-iso">
        <label for="node-input-iso"><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.iso"></span></label>
        <select id="node-input-iso" style="width: 100px" >
            <option value="0">auto</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="320">320</option>
            <option value="400">400</option>
            <option value="500">500</option>
            <option value="640">640</option>
            <option value="800">800</option>
        </select>
    </div>
    <div class="form-row">
        <label><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.presets"></span></label>

        <label for="node-input-exposuremode" style="width: 80px;"><span data-i18n="camerapi.label.exposuremode"></span></label>
        <select id="node-input-exposuremode" style="width: 212px;">
            <option value="auto">auto</option>
            <option value="night">night</option>
            <option value="nightpreview">nightpreview</option>
            <option value="backlight">backlight</option>
            <option value="spotlight">spotlight</option>
            <option value="sports">spots</option>
            <option value="snow">snow</option>
            <option value="beach">beach</option>
            <option value="verylong">verylong</option>
            <option value="fixedfps">fixedfps</option>
            <option value="antishake">antishake</option>
            <option value="fireworks">fireworks</option>
            <!--option value="off">off</option>-->
        </select>
    </div>
    <div class="form-row">
        <label></label>

        <label for="node-input-awb" style="width: 80px;"><span data-i18n="camerapi.label.awb"></span></label>
         <select id="node-input-awb" style="width: 212px;">
             <option value="auto">auto</option>
             <option value="sunlight">sunlight</option>
             <option value="cloudy">cloudy</option>
             <option value="shade">shade</option>
             <option value="tungsten">tungsten</option>
             <option value="fluorescent">fluorescent</option>
             <option value="incandescent">incandescent</option>
             <option value="flash">flash</option>
             <option value="horizon">horizon</option>
         </select>
    </div>
    <div class="form-row">
        <label for="node-input-agcwait"><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.agcwait"></span></label>
		<input type="text" style="width: 100px" id="node-input-agcwait" placeholder="0.0 to 1.0" >
 
        &nbsp;<label for="node-input-led" style="width: 60px; margin-left: 24px;"><i class="fa fa-camera"></i> <span data-i18n="camerapi.label.led"></span></label>
	    <select style="width: 100px" id="node-input-led">
            <option value="1" data-i18n="camerapi.options.on"></option>
            <option value="0" data-i18n="camerapi.options.off"></option>
	   </select>
    </div>  
    </br>
    <div class="form-row node-input-name">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="camerapi.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]camerapi.placeholder.name" style="width: 296px;">
    </div>
</script>

<script type="text/x-red" data-help-name="camerapi-takephoto">
    <p>Takes picture using the Raspberry Pi camera module.</p>
    <p>Requires a Raspberry Pi camera module and picamera Python library</p>

    <h3>Inputs</h3>
        <dl class="message-properties">
            <dt class="optional">msg.filemode
                <span class="property-type">string</span>
            </dt>
            <dd>Overrides the File Mode defined in node editor. Possible file modes: "0", "1" and "2".</dd>
            <dt class="optional">msg.filename
                <span class="property-type">string</span>
            </dt>
            <dd>Overrides the File Name defined in node editor.</dd>
            <dt class="optional">msg.filepath
                <span class="property-type">string</span>
            </dt>
            <dd>Overrides the File Path defined in node editor.</dd>
            <dt class="optional">msg.fileformat
                <span class="property-type">string</span>
            </dt>
            <dd>Overrides the File Format defined in node editor.</dd>
        </dl>

    <h3>Outputs</h3>
        <ol class="node-ports">
            <li>Standard output
                <dl class="message-properties">
                    <dt>payload <span class="property-type">string</span></dt>
                    <dd>
                        <p>For filemode "0" (buffered mode), payload contains the raw image as a binary object.</p>
                        <p>For filemode "1" (custom file name) and "2" (auto file name), payload contains the fully qualified file name of the file containing the image.</p>
                    </dd>
                </dl>
            </li>
        </ol>

    <h3>Details</h3>
        <p>File Mode indicates the operation mode, which can be:
            <ol type = "1" start = "0">
                <li>Buffered mode - the raw image will be sent to the next node(s) in <code>msg.payload</code></li>
                <li>Custom file name - the image will be stored in a file with the specified file name.</li>
                <li>Auto file name - the image will be stored in a file and its name automatically generated.</li>
            </ol>
        </p>
        <p>File Name defines the name of the file in which the node will save the photo, if File Mode is "Custom file name".</p>
        <p>File Default Path, when set to Yes (<code>msg.filedefpath = "1"</code>), will save all photos in the default folder (~/Pictures), therefore, make sure the directory is created and node-red process has permission to write files in the folder.</p>
        <p>File Path specifies the path where photos are saved, when File Default Path is No (<code>msg.filedefpath = "0")</code>).</p>
        <p>File Format defines the format of the file. The following formats are supported: JPEG (default), PNG, GIF, BMP, YUV, RGB, RGBA, BGR, BGRA.</p>
        <p>Resolution, the image resolution in pixels.</p>
        <p>Rotation, rotates the image (in degrees).</p>
        <p>Image Flip, flips image horizontally and vertically, independently.</p>
        <p>Brightness ajusts the brightness of the camera as an number from 0 to 100 (default 50).</p>
        <p>Contrast sets the contrast level as an number from -100 to 100 (default 0).</p>
        <p>Sharpness adjusts the sharpness of the camera, a measure of the amount of post-processing to reduce or increase image sharpness. Ranges from -100 to 100 (default 0).</p>
        <p>Quality is used to control JPEG compression (from 0 - low quality and high compression; to 100 - high quality and no compression). Quality is ignored by all other image formats but JPEG (default 80).</p>
        <p>Image Effect defines the effect to by applied to the image. The following effects are defined, although not all of them are fully supported by every camera module:
            <ul>
                <li>none: no effect (default)</li>
                <li>negative: invert the image colours</li>
                <li>solarise: solarise the image</li>
                <li>posterise: posterise the image</li>
                <li>whiteboard: whiteboard effect</li>
                <li>blackboard: blackboard effect</li>
                <li>sketch: sketch effect</li>
                <li>denoise: denoise the image</li>
                <li>emboss: emboss the image</li>
                <li>oilpaint: oil paint effect</li>
                <li>hatch: hatch sketch effect</li>
                <li>gpen: graphite sketch effect</li>
                <li>pastel: pastel effect</li>
                <li>watercolour: watercolour effect</li>
                <li>film: film grain effect</li>
                <li>blur: blur the image</li>
                <li>saturation: colour saturate the image</li>
                <li>colourswap: not fully implemented</li>
                <li>washedout: not fully implemented</li>
                <li>colourpoint: not fully implemented</li>
                <li>colourbalance: not fully implemented</li>
                <li>cartoon: not fully implemented</li>
            </ul>
        </p>
        <p>ISO sets the apparent ISO setting of the camera (default auto). When set to auto, it will automatically determine a value according to image-taking conditions. When set to one of the ISO values, it will adjust the camera sensitivity accordingly.</p>
        <p>Exposure mode, adjusts camera exposure mode with one of the presets, thus pre-defining the camera's sensitivity, speed and gain.</p>
        <p>AWB mode sets the auto-white-balance, which adjusts the colour balance used by the camera. When set to auto (default), it will try to correct the colours in the image depending on the light conditions of the scene, producing images with more neutral colours.</p>
        <p>Wait for AGC is the delay between camera initialization and shooting. Proper wait time is important to let the camera sensors adapt to the scene and set correct exposure (default 0.3s).</p>
        <p>LED controls the state of the camera's LED via GPIO - "1" On and "0" Off (default "Off"). At the present moment, the camera's LED cannot be controlled on the Pi 3, which had GPIOs re-routed to the GPIO expander, but it's typically used on the Compute Module platform.</p>
        

    <h3>Reference</h3>
        <ul>
            <li><a href="https://www.raspberrypi.org/documentation/hardware/camera/README.md" target="_blank">Camera module v2</a></li>
            <li><a href="https://picamera.readthedocs.io/en/release-1.13/index.html" target="_blank">picamera</a></li>
        </ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType("camerapi-takephoto",{
        category: "Raspberry_Pi",
        color: "#A6BBCF",
        defaults: {
            filemode: {value:"2", required:true},
            filename: {value:"", required:false},
            filedefpath: {value:"1", required:true},
            filepath: {value:"", required:false},
            fileformat: {value:"jpeg", required:true},
            resolution: {value:"10", required:true},
            rotation : {value:"0", required:true},
            fliph: {value:"0", required:true},
            flipv: {value:"0", required:true},
            brightness: {value:"50", required:true},
            contrast: {value:"0", required:true},
            sharpness: {value:"0", required:true},
            quality: {value:"80", required:false},
            imageeffect: {value:"none", required:true},
            exposuremode: {value:"auto", required:true}, 
            iso: {value:"0", required:true},
            agcwait: {value:"1.0", required:false},
            led: {value:"0", required:false},
            awb: {value:"auto", required:false},
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "photo.png",
        oneditprepare: function() {
            $("#node-input-filemode").change(function() {
                var choose = $("#node-input-filemode").val();
                console.log(choose);
                if (choose == "0") {
                	console.log("Buffermode - yes");
                	$("#filename").hide();
                    $("#node-input-filedefpath").val("1");
                    $("#node-input-filepath").val("");
                	$("#filedefpath").hide();
                	$("#filepath").hide();
                	$("#fileformat").hide();
                } else if (choose == "2") {
                	console.log("Generate - yes");
                	$("#filename").hide();
                    $("#node-input-filedefpath").val("1");
                    $("#node-input-filepath").val("");
                	$("#filedefpath").hide();
                	$("#filepath").hide();
                	$("#fileformat").hide();                    
                } else {
                	console.log("FileMode - yes");
                	$("#filename").show();
                	$("#filedefpath").show();
                	$("#filepath").hide();
                	$("#fileformat").show();
                }
            });
            $("#node-input-filedefpath").change(function() {
                var choose = $("#node-input-filedefpath").val();
                console.log(choose);
                if (choose == "0") {
                	console.log("FileDefPath - no");
                	$("#filepath").show();
                } else {
                	console.log("FileDefPath - yes");
                	$("#filepath").hide();
                    $("#node-input-filepath").val("");
                }
            });
        },
        label: function() {
            return this.name || "take photo node";
        }
    });
</script>
<!-- End of CameraPi Take Photo Node -->
